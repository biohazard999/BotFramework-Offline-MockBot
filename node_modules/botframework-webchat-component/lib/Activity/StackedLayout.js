"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.connectStackedLayout = exports.default = void 0;

var _botframeworkWebchatCore = require("botframework-webchat-core");

var _glamor = require("glamor");

var _classnames = _interopRequireDefault(require("classnames"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireDefault(require("react"));

var _remark = _interopRequireDefault(require("remark"));

var _stripMarkdown = _interopRequireDefault(require("strip-markdown"));

var _Localize = require("../Localization/Localize");

var _Avatar = _interopRequireDefault(require("./Avatar"));

var _Bubble = _interopRequireDefault(require("./Bubble"));

var _connectToWebChat = _interopRequireDefault(require("../connectToWebChat"));

var _SendStatus = _interopRequireDefault(require("./SendStatus"));

var _textFormatToContentType = _interopRequireDefault(require("../Utils/textFormatToContentType"));

var _Timestamp = _interopRequireDefault(require("./Timestamp"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* eslint-disable no-sync */

/* eslint react/no-array-index-key: "off" */
var _Constants$ActivityCl = _botframeworkWebchatCore.Constants.ActivityClientState,
    SENDING = _Constants$ActivityCl.SENDING,
    SEND_FAILED = _Constants$ActivityCl.SEND_FAILED;
var ROOT_CSS = (0, _glamor.css)({
  display: 'flex',
  '& > .avatar': {
    flexShrink: 0
  },
  '& > .content': {
    flexGrow: 1,
    overflow: 'hidden',
    '& > .webchat__row': {
      display: 'flex',
      '& > .bubble, & > .timestamp': {
        flexGrow: 1,
        overflow: 'hidden'
      },
      '& > .filler': {
        flexGrow: 10000,
        flexShrink: 1
      }
    }
  },
  '& > .filler': {
    flexShrink: 0
  },
  '&.from-user': {
    flexDirection: 'row-reverse',
    '& > .content > .webchat__row': {
      flexDirection: 'row-reverse'
    }
  }
});

var connectStackedLayout = function connectStackedLayout() {
  for (var _len = arguments.length, selectors = new Array(_len), _key = 0; _key < _len; _key++) {
    selectors[_key] = arguments[_key];
  }

  return _connectToWebChat.default.apply(void 0, [function (_ref, _ref2) {
    var language = _ref.language,
        _ref$styleSet$options = _ref.styleSet.options,
        botAvatarInitials = _ref$styleSet$options.botAvatarInitials,
        userAvatarInitials = _ref$styleSet$options.userAvatarInitials;
    var _ref2$activity = _ref2.activity;
    _ref2$activity = _ref2$activity === void 0 ? {} : _ref2$activity;
    var _ref2$activity$from = _ref2$activity.from;
    _ref2$activity$from = _ref2$activity$from === void 0 ? {} : _ref2$activity$from;
    var role = _ref2$activity$from.role;
    return {
      avatarInitials: role === 'user' ? userAvatarInitials : botAvatarInitials,
      language: language,
      // TODO: [P4] We want to deprecate botAvatarInitials/userAvatarInitials because they are not as helpful as avatarInitials
      botAvatarInitials: botAvatarInitials,
      userAvatarInitials: userAvatarInitials
    };
  }].concat(selectors));
};

exports.connectStackedLayout = connectStackedLayout;

var StackedLayout = function StackedLayout(_ref3) {
  var activity = _ref3.activity,
      avatarInitials = _ref3.avatarInitials,
      children = _ref3.children,
      language = _ref3.language,
      styleSet = _ref3.styleSet,
      timestampClassName = _ref3.timestampClassName;
  var _activity$attachments = activity.attachments,
      attachments = _activity$attachments === void 0 ? [] : _activity$attachments,
      _activity$channelData = activity.channelData;
  _activity$channelData = _activity$channelData === void 0 ? {} : _activity$channelData;
  var _activity$channelData2 = _activity$channelData.messageBack;
  _activity$channelData2 = _activity$channelData2 === void 0 ? {} : _activity$channelData2;
  var messageBackDisplayText = _activity$channelData2.displayText,
      state = _activity$channelData.state,
      _activity$from = activity.from;
  _activity$from = _activity$from === void 0 ? {} : _activity$from;
  var role = _activity$from.role,
      text = activity.text,
      textFormat = activity.textFormat,
      type = activity.type;
  var activityDisplayText = messageBackDisplayText || text;
  var fromUser = role === 'user';
  var showSendStatus = state === SENDING || state === SEND_FAILED;
  var plainText = (0, _remark.default)().use(_stripMarkdown.default).processSync(text);
  var ariaLabel = (0, _Localize.localize)(fromUser ? 'User said something' : 'Bot said something', language, avatarInitials, plainText);
  return _react.default.createElement("div", {
    className: (0, _classnames.default)(ROOT_CSS + '', styleSet.stackedLayout + '', {
      'from-user': fromUser
    })
  }, _react.default.createElement(_Avatar.default, {
    "aria-hidden": true,
    className: "avatar",
    fromUser: fromUser
  }), _react.default.createElement("div", {
    className: "content"
  }, type === 'typing' ? _react.default.createElement("div", {
    className: "webchat__row typing"
  }, children({
    activity: activity,
    attachment: {
      contentType: 'typing'
    }
  }), _react.default.createElement("div", {
    className: "filler"
  })) : !!activityDisplayText && _react.default.createElement("div", {
    "aria-label": ariaLabel,
    className: "webchat__row message"
  }, _react.default.createElement(_Bubble.default, {
    "aria-hidden": true,
    className: "bubble",
    fromUser: fromUser
  }, children({
    activity: activity,
    attachment: {
      content: activityDisplayText,
      contentType: (0, _textFormatToContentType.default)(textFormat)
    }
  })), _react.default.createElement("div", {
    className: "filler"
  })), attachments.map(function (attachment, index) {
    return _react.default.createElement("div", {
      className: "webchat__row attachment",
      key: index
    }, _react.default.createElement(_Bubble.default, {
      "aria-hidden": true,
      className: "attachment bubble",
      fromUser: fromUser,
      key: index
    }, children({
      attachment: attachment
    })));
  }), _react.default.createElement("div", {
    className: "webchat__row"
  }, showSendStatus ? _react.default.createElement(_SendStatus.default, {
    activity: activity,
    className: "timestamp"
  }) : _react.default.createElement(_Timestamp.default, {
    activity: activity,
    "aria-hidden": true,
    className: (0, _classnames.default)('timestamp', timestampClassName)
  }), _react.default.createElement("div", {
    className: "filler"
  }))), _react.default.createElement("div", {
    className: "filler"
  }));
};

StackedLayout.defaultProps = {
  children: undefined,
  timestampClassName: ''
};
StackedLayout.propTypes = {
  activity: _propTypes.default.shape({
    attachments: _propTypes.default.array,
    channelData: _propTypes.default.shape({
      messageBack: _propTypes.default.shape({
        displayText: _propTypes.default.string
      })
    }),
    from: _propTypes.default.shape({
      role: _propTypes.default.string.isRequired
    }).isRequired,
    text: _propTypes.default.string,
    textFormat: _propTypes.default.string,
    timestamp: _propTypes.default.string,
    type: _propTypes.default.string.isRequired
  }).isRequired,
  avatarInitials: _propTypes.default.string.isRequired,
  children: _propTypes.default.any,
  language: _propTypes.default.string.isRequired,
  styleSet: _propTypes.default.shape({
    stackedLayout: _propTypes.default.any.isRequired
  }).isRequired,
  timestampClassName: _propTypes.default.string
};

var _default = connectStackedLayout(function (_ref4) {
  var avatarInitials = _ref4.avatarInitials,
      language = _ref4.language,
      styleSet = _ref4.styleSet;
  return {
    avatarInitials: avatarInitials,
    language: language,
    styleSet: styleSet
  };
})(StackedLayout);

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9BY3Rpdml0eS9TdGFja2VkTGF5b3V0LmpzIl0sIm5hbWVzIjpbIkNvbnN0YW50cyIsIkFjdGl2aXR5Q2xpZW50U3RhdGUiLCJTRU5ESU5HIiwiU0VORF9GQUlMRUQiLCJST09UX0NTUyIsImRpc3BsYXkiLCJmbGV4U2hyaW5rIiwiZmxleEdyb3ciLCJvdmVyZmxvdyIsImZsZXhEaXJlY3Rpb24iLCJjb25uZWN0U3RhY2tlZExheW91dCIsInNlbGVjdG9ycyIsImNvbm5lY3RUb1dlYkNoYXQiLCJsYW5ndWFnZSIsInN0eWxlU2V0Iiwib3B0aW9ucyIsImJvdEF2YXRhckluaXRpYWxzIiwidXNlckF2YXRhckluaXRpYWxzIiwiYWN0aXZpdHkiLCJmcm9tIiwicm9sZSIsImF2YXRhckluaXRpYWxzIiwiU3RhY2tlZExheW91dCIsImNoaWxkcmVuIiwidGltZXN0YW1wQ2xhc3NOYW1lIiwiYXR0YWNobWVudHMiLCJjaGFubmVsRGF0YSIsIm1lc3NhZ2VCYWNrIiwibWVzc2FnZUJhY2tEaXNwbGF5VGV4dCIsImRpc3BsYXlUZXh0Iiwic3RhdGUiLCJ0ZXh0IiwidGV4dEZvcm1hdCIsInR5cGUiLCJhY3Rpdml0eURpc3BsYXlUZXh0IiwiZnJvbVVzZXIiLCJzaG93U2VuZFN0YXR1cyIsInBsYWluVGV4dCIsInVzZSIsInN0cmlwTWFya2Rvd24iLCJwcm9jZXNzU3luYyIsImFyaWFMYWJlbCIsInN0YWNrZWRMYXlvdXQiLCJhdHRhY2htZW50IiwiY29udGVudFR5cGUiLCJjb250ZW50IiwibWFwIiwiaW5kZXgiLCJkZWZhdWx0UHJvcHMiLCJ1bmRlZmluZWQiLCJwcm9wVHlwZXMiLCJQcm9wVHlwZXMiLCJzaGFwZSIsImFycmF5Iiwic3RyaW5nIiwiaXNSZXF1aXJlZCIsInRpbWVzdGFtcCIsImFueSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUdBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztB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QXNCeEIvQixFQUFBQSxrQkFBa0IsRUFBRTJCLG1CQUFVRztBQXRCTixDQUExQjs7ZUF5QmU1QyxvQkFBb0IsQ0FBQztBQUFBLE1BQUdXLGNBQUgsU0FBR0EsY0FBSDtBQUFBLE1BQW1CUixRQUFuQixTQUFtQkEsUUFBbkI7QUFBQSxNQUE2QkMsUUFBN0IsU0FBNkJBLFFBQTdCO0FBQUEsU0FBNkM7QUFDL0VPLElBQUFBLGNBQWMsRUFBZEEsY0FEK0U7QUFFL0VSLElBQUFBLFFBQVEsRUFBUkEsUUFGK0U7QUFHL0VDLElBQUFBLFFBQVEsRUFBUkE7QUFIK0UsR0FBN0M7QUFBQSxDQUFELENBQXBCLENBSVhRLGFBSlcsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIG5vLXN5bmMgKi9cbi8qIGVzbGludCByZWFjdC9uby1hcnJheS1pbmRleC1rZXk6IFwib2ZmXCIgKi9cblxuaW1wb3J0IHsgQ29uc3RhbnRzIH0gZnJvbSAnYm90ZnJhbWV3b3JrLXdlYmNoYXQtY29yZSc7XG5pbXBvcnQgeyBjc3MgfSBmcm9tICdnbGFtb3InO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCByZW1hcmsgZnJvbSAncmVtYXJrJztcbmltcG9ydCBzdHJpcE1hcmtkb3duIGZyb20gJ3N0cmlwLW1hcmtkb3duJztcblxuaW1wb3J0IHsgbG9jYWxpemUgfSBmcm9tICcuLi9Mb2NhbGl6YXRpb24vTG9jYWxpemUnO1xuaW1wb3J0IEF2YXRhciBmcm9tICcuL0F2YXRhcic7XG5pbXBvcnQgQnViYmxlIGZyb20gJy4vQnViYmxlJztcbmltcG9ydCBjb25uZWN0VG9XZWJDaGF0IGZyb20gJy4uL2Nvbm5lY3RUb1dlYkNoYXQnO1xuaW1wb3J0IFNlbmRTdGF0dXMgZnJvbSAnLi9TZW5kU3RhdHVzJztcbmltcG9ydCB0ZXh0Rm9ybWF0VG9Db250ZW50VHlwZSBmcm9tICcuLi9VdGlscy90ZXh0Rm9ybWF0VG9Db250ZW50VHlwZSc7XG5pbXBvcnQgVGltZXN0YW1wIGZyb20gJy4vVGltZXN0YW1wJztcblxuY29uc3Qge1xuICBBY3Rpdml0eUNsaWVudFN0YXRlOiB7IFNFTkRJTkcsIFNFTkRfRkFJTEVEIH1cbn0gPSBDb25zdGFudHM7XG5cbmNvbnN0IFJPT1RfQ1NTID0gY3NzKHtcbiAgZGlzcGxheTogJ2ZsZXgnLFxuXG4gICcmID4gLmF2YXRhcic6IHtcbiAgICBmbGV4U2hyaW5rOiAwXG4gIH0sXG5cbiAgJyYgPiAuY29udGVudCc6IHtcbiAgICBmbGV4R3JvdzogMSxcbiAgICBvdmVyZmxvdzogJ2hpZGRlbicsXG5cbiAgICAnJiA+IC53ZWJjaGF0X19yb3cnOiB7XG4gICAgICBkaXNwbGF5OiAnZmxleCcsXG5cbiAgICAgICcmID4gLmJ1YmJsZSwgJiA+IC50aW1lc3RhbXAnOiB7XG4gICAgICAgIGZsZXhHcm93OiAxLFxuICAgICAgICBvdmVyZmxvdzogJ2hpZGRlbidcbiAgICAgIH0sXG5cbiAgICAgICcmID4gLmZpbGxlcic6IHtcbiAgICAgICAgZmxleEdyb3c6IDEwMDAwLFxuICAgICAgICBmbGV4U2hyaW5rOiAxXG4gICAgICB9XG4gICAgfVxuICB9LFxuXG4gICcmID4gLmZpbGxlcic6IHtcbiAgICBmbGV4U2hyaW5rOiAwXG4gIH0sXG5cbiAgJyYuZnJvbS11c2VyJzoge1xuICAgIGZsZXhEaXJlY3Rpb246ICdyb3ctcmV2ZXJzZScsXG5cbiAgICAnJiA+IC5jb250ZW50ID4gLndlYmNoYXRfX3Jvdyc6IHtcbiAgICAgIGZsZXhEaXJlY3Rpb246ICdyb3ctcmV2ZXJzZSdcbiAgICB9XG4gIH1cbn0pO1xuXG5jb25zdCBjb25uZWN0U3RhY2tlZExheW91dCA9ICguLi5zZWxlY3RvcnMpID0+XG4gIGNvbm5lY3RUb1dlYkNoYXQoXG4gICAgKFxuICAgICAge1xuICAgICAgICBsYW5ndWFnZSxcbiAgICAgICAgc3R5bGVTZXQ6IHtcbiAgICAgICAgICBvcHRpb25zOiB7IGJvdEF2YXRhckluaXRpYWxzLCB1c2VyQXZhdGFySW5pdGlhbHMgfVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgeyBhY3Rpdml0eTogeyBmcm9tOiB7IHJvbGUgfSA9IHt9IH0gPSB7fSB9XG4gICAgKSA9PiAoe1xuICAgICAgYXZhdGFySW5pdGlhbHM6IHJvbGUgPT09ICd1c2VyJyA/IHVzZXJBdmF0YXJJbml0aWFscyA6IGJvdEF2YXRhckluaXRpYWxzLFxuICAgICAgbGFuZ3VhZ2UsXG5cbiAgICAgIC8vIFRPRE86IFtQNF0gV2Ugd2FudCB0byBkZXByZWNhdGUgYm90QXZhdGFySW5pdGlhbHMvdXNlckF2YXRhckluaXRpYWxzIGJlY2F1c2UgdGhleSBhcmUgbm90IGFzIGhlbHBmdWwgYXMgYXZhdGFySW5pdGlhbHNcbiAgICAgIGJvdEF2YXRhckluaXRpYWxzLFxuICAgICAgdXNlckF2YXRhckluaXRpYWxzXG4gICAgfSksXG4gICAgLi4uc2VsZWN0b3JzXG4gICk7XG5cbmNvbnN0IFN0YWNrZWRMYXlvdXQgPSAoeyBhY3Rpdml0eSwgYXZhdGFySW5pdGlhbHMsIGNoaWxkcmVuLCBsYW5ndWFnZSwgc3R5bGVTZXQsIHRpbWVzdGFtcENsYXNzTmFtZSB9KSA9PiB7XG4gIGNvbnN0IHtcbiAgICBhdHRhY2htZW50cyA9IFtdLFxuICAgIGNoYW5uZWxEYXRhOiB7IG1lc3NhZ2VCYWNrOiB7IGRpc3BsYXlUZXh0OiBtZXNzYWdlQmFja0Rpc3BsYXlUZXh0IH0gPSB7fSwgc3RhdGUgfSA9IHt9LFxuICAgIGZyb206IHsgcm9sZSB9ID0ge30sXG4gICAgdGV4dCxcbiAgICB0ZXh0Rm9ybWF0LFxuICAgIHR5cGVcbiAgfSA9IGFjdGl2aXR5O1xuXG4gIGNvbnN0IGFjdGl2aXR5RGlzcGxheVRleHQgPSBtZXNzYWdlQmFja0Rpc3BsYXlUZXh0IHx8IHRleHQ7XG4gIGNvbnN0IGZyb21Vc2VyID0gcm9sZSA9PT0gJ3VzZXInO1xuICBjb25zdCBzaG93U2VuZFN0YXR1cyA9IHN0YXRlID09PSBTRU5ESU5HIHx8IHN0YXRlID09PSBTRU5EX0ZBSUxFRDtcbiAgY29uc3QgcGxhaW5UZXh0ID0gcmVtYXJrKClcbiAgICAudXNlKHN0cmlwTWFya2Rvd24pXG4gICAgLnByb2Nlc3NTeW5jKHRleHQpO1xuICBjb25zdCBhcmlhTGFiZWwgPSBsb2NhbGl6ZShcbiAgICBmcm9tVXNlciA/ICdVc2VyIHNhaWQgc29tZXRoaW5nJyA6ICdCb3Qgc2FpZCBzb21ldGhpbmcnLFxuICAgIGxhbmd1YWdlLFxuICAgIGF2YXRhckluaXRpYWxzLFxuICAgIHBsYWluVGV4dFxuICApO1xuXG4gIHJldHVybiAoXG4gICAgPGRpdiBjbGFzc05hbWU9e2NsYXNzTmFtZXMoUk9PVF9DU1MgKyAnJywgc3R5bGVTZXQuc3RhY2tlZExheW91dCArICcnLCB7ICdmcm9tLXVzZXInOiBmcm9tVXNlciB9KX0+XG4gICAgICA8QXZhdGFyIGFyaWEtaGlkZGVuPXt0cnVlfSBjbGFzc05hbWU9XCJhdmF0YXJcIiBmcm9tVXNlcj17ZnJvbVVzZXJ9IC8+XG4gICAgICA8ZGl2IGNsYXNzTmFtZT1cImNvbnRlbnRcIj5cbiAgICAgICAge3R5cGUgPT09ICd0eXBpbmcnID8gKFxuICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwid2ViY2hhdF9fcm93IHR5cGluZ1wiPlxuICAgICAgICAgICAge2NoaWxkcmVuKHtcbiAgICAgICAgICAgICAgYWN0aXZpdHksXG4gICAgICAgICAgICAgIGF0dGFjaG1lbnQ6IHsgY29udGVudFR5cGU6ICd0eXBpbmcnIH1cbiAgICAgICAgICAgIH0pfVxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJmaWxsZXJcIiAvPlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICApIDogKFxuICAgICAgICAgICEhYWN0aXZpdHlEaXNwbGF5VGV4dCAmJiAoXG4gICAgICAgICAgICA8ZGl2IGFyaWEtbGFiZWw9e2FyaWFMYWJlbH0gY2xhc3NOYW1lPVwid2ViY2hhdF9fcm93IG1lc3NhZ2VcIj5cbiAgICAgICAgICAgICAgPEJ1YmJsZSBhcmlhLWhpZGRlbj17dHJ1ZX0gY2xhc3NOYW1lPVwiYnViYmxlXCIgZnJvbVVzZXI9e2Zyb21Vc2VyfT5cbiAgICAgICAgICAgICAgICB7Y2hpbGRyZW4oe1xuICAgICAgICAgICAgICAgICAgYWN0aXZpdHksXG4gICAgICAgICAgICAgICAgICBhdHRhY2htZW50OiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IGFjdGl2aXR5RGlzcGxheVRleHQsXG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlOiB0ZXh0Rm9ybWF0VG9Db250ZW50VHlwZSh0ZXh0Rm9ybWF0KVxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pfVxuICAgICAgICAgICAgICA8L0J1YmJsZT5cbiAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJmaWxsZXJcIiAvPlxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgKVxuICAgICAgICApfVxuICAgICAgICB7YXR0YWNobWVudHMubWFwKChhdHRhY2htZW50LCBpbmRleCkgPT4gKFxuICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwid2ViY2hhdF9fcm93IGF0dGFjaG1lbnRcIiBrZXk9e2luZGV4fT5cbiAgICAgICAgICAgIDxCdWJibGUgYXJpYS1oaWRkZW49e3RydWV9IGNsYXNzTmFtZT1cImF0dGFjaG1lbnQgYnViYmxlXCIgZnJvbVVzZXI9e2Zyb21Vc2VyfSBrZXk9e2luZGV4fT5cbiAgICAgICAgICAgICAge2NoaWxkcmVuKHsgYXR0YWNobWVudCB9KX1cbiAgICAgICAgICAgIDwvQnViYmxlPlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICApKX1cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJ3ZWJjaGF0X19yb3dcIj5cbiAgICAgICAgICB7c2hvd1NlbmRTdGF0dXMgPyAoXG4gICAgICAgICAgICA8U2VuZFN0YXR1cyBhY3Rpdml0eT17YWN0aXZpdHl9IGNsYXNzTmFtZT1cInRpbWVzdGFtcFwiIC8+XG4gICAgICAgICAgKSA6IChcbiAgICAgICAgICAgIDxUaW1lc3RhbXAgYWN0aXZpdHk9e2FjdGl2aXR5fSBhcmlhLWhpZGRlbj17dHJ1ZX0gY2xhc3NOYW1lPXtjbGFzc05hbWVzKCd0aW1lc3RhbXAnLCB0aW1lc3RhbXBDbGFzc05hbWUpfSAvPlxuICAgICAgICAgICl9XG4gICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJmaWxsZXJcIiAvPlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvZGl2PlxuICAgICAgPGRpdiBjbGFzc05hbWU9XCJmaWxsZXJcIiAvPlxuICAgIDwvZGl2PlxuICApO1xufTtcblxuU3RhY2tlZExheW91dC5kZWZhdWx0UHJvcHMgPSB7XG4gIGNoaWxkcmVuOiB1bmRlZmluZWQsXG4gIHRpbWVzdGFtcENsYXNzTmFtZTogJydcbn07XG5cblN0YWNrZWRMYXlvdXQucHJvcFR5cGVzID0ge1xuICBhY3Rpdml0eTogUHJvcFR5cGVzLnNoYXBlKHtcbiAgICBhdHRhY2htZW50czogUHJvcFR5cGVzLmFycmF5LFxuICAgIGNoYW5uZWxEYXRhOiBQcm9wVHlwZXMuc2hhcGUoe1xuICAgICAgbWVzc2FnZUJhY2s6IFByb3BUeXBlcy5zaGFwZSh7XG4gICAgICAgIGRpc3BsYXlUZXh0OiBQcm9wVHlwZXMuc3RyaW5nXG4gICAgICB9KVxuICAgIH0pLFxuICAgIGZyb206IFByb3BUeXBlcy5zaGFwZSh7XG4gICAgICByb2xlOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWRcbiAgICB9KS5pc1JlcXVpcmVkLFxuICAgIHRleHQ6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgdGV4dEZvcm1hdDogUHJvcFR5cGVzLnN0cmluZyxcbiAgICB0aW1lc3RhbXA6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgdHlwZTogUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkXG4gIH0pLmlzUmVxdWlyZWQsXG4gIGF2YXRhckluaXRpYWxzOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXG4gIGNoaWxkcmVuOiBQcm9wVHlwZXMuYW55LFxuICBsYW5ndWFnZTogUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkLFxuICBzdHlsZVNldDogUHJvcFR5cGVzLnNoYXBlKHtcbiAgICBzdGFja2VkTGF5b3V0OiBQcm9wVHlwZXMuYW55LmlzUmVxdWlyZWRcbiAgfSkuaXNSZXF1aXJlZCxcbiAgdGltZXN0YW1wQ2xhc3NOYW1lOiBQcm9wVHlwZXMuc3RyaW5nXG59O1xuXG5leHBvcnQgZGVmYXVsdCBjb25uZWN0U3RhY2tlZExheW91dCgoeyBhdmF0YXJJbml0aWFscywgbGFuZ3VhZ2UsIHN0eWxlU2V0IH0pID0+ICh7XG4gIGF2YXRhckluaXRpYWxzLFxuICBsYW5ndWFnZSxcbiAgc3R5bGVTZXRcbn0pKShTdGFja2VkTGF5b3V0KTtcblxuZXhwb3J0IHsgY29ubmVjdFN0YWNrZWRMYXlvdXQgfTtcbiJdfQ==